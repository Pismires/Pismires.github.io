<!DOCTYPE html>
<html>
<head>
	<link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/css/bootstrap.min.css" integrity="sha384-MCw98/SFnGE8fJT3GXwEOngsV7Zt27NXFoaoApmYm81iuXoPkFOJwJ8ERdknLPMO" crossorigin="anonymous">
	<link rel="stylesheet" type="text/css" href="https://bootswatch.com/4/slate/bootstrap.min.css">
	<script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular.min.js"></script>
	<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.6.9/angular-resource.min.js"></script>
	<title>ezBiz Milestones Moniter</title>
</head>
<body ng-app="milestonesList" ng-controller="milestonesCtrl">
	<nav class="navbar navbar-expand-lg navbar-dark bg-primary">
	  <a class="navbar-brand" href="#">ezBiz Milestones Moniter</a>
	  <div class="collapse navbar-collapse" id="navbarSupportedContent">
	      <ul class="navbar-nav mr-auto">
		    <li class="nav-item dropdown">
	  	        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
	  	          Milestones
	  	        </a>
	  	        <div class="dropdown-menu" aria-labelledby="navbarDropdown">
	  	          <a class="dropdown-item" href="#" ng-repeat="milestone in milestones" ng-click="loadIssues(milestone.id)">
	  	          	  {{milestone.title}}
	  	          	  <span ng-if="milestone.state == 'active'" class="badge badge-success">Active</span>
	  	          	  <span ng-if="milestone.state == 'closed'" class="badge badge-warning">Closed</span>
	  	          </a>
	  	        </div>
	  	    </li>
	      </ul>
	  </div>
	  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarColor01" aria-controls="navbarColor01" aria-expanded="false" aria-label="Toggle navigation">
	    <span class="navbar-toggler-icon"></span>
	  </button>
	</nav>

	<div ng-if="errorMain" class="alert alert-danger alert-dismissible fade show" role="alert">
	  <strong>Error</strong> {{errorMain}}
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
	    <span aria-hidden="true">&times;</span>
	  </button>
	</div>

	<div ng-if="errorSub" class="alert alert-warning alert-dismissible fade show" role="alert">
	  <strong>Error</strong> {{errorSub}}
	  <button type="button" class="close" data-dismiss="alert" aria-label="Close">
	    <span aria-hidden="true">&times;</span>
	  </button>
	</div>

	<div class="container" ng-if="issues" style="padding-top: 50px">
		
		<ul class="nav nav-tabs">
		  <li class="nav-item">
		    <a class="nav-link active show" data-toggle="tab" href="#details">Details</a>
		  </li>
		  <li class="nav-item">
		    <a class="nav-link" data-toggle="tab" href="#issue">Issues</a>
		  </li>
		  <li class="nav-item">
		    <a class="nav-link" data-toggle="tab" href="#participants">Participants</a>
		  </li>
		</ul>
		<div id="myTabContent" class="tab-content">
			
			<div class="tab-pane fade active show" id="details">
				<div class="row" style="padding-top: 20px">
					<div class="col-4">
						<h1>{{percentage}}%</h1>
						<div class="progress">
						  <div class="progress-bar progress-bar-striped bg-success progress-bar-animated" role="progressbar" aria-valuenow="{{percentage}}" aria-valuemin="0" aria-valuemax="100" style="width: {{percentage}}%"></div>
						</div>
						<hr/>
						<h5>Number of dev : {{nOfParticipant}}</h5>
						<h5>Total time : {{totalTime}}</h5>
						<h5>Total ETA : {{totalETA}}</h5>
					</div>
					<div class="col-8">
						<h2>{{details.title}}</h2>
						<h5>
							<li>description: {{details.description}}</li>
							<li>state: {{details.state}}</li>
							<li>created_at: {{details.created_at}}</li>
							<li>updated_at: {{details.updated_at}}</li>
							<li>due_date: {{details.due_date}}</li>
							<li>start_date: {{details.start_date}}</li>
						</h5>
					</div>
				</div>
			</div>

			<div class="tab-pane fade" id="issue">
			<table class="table table-hover">
			  <thead>
			    <tr class="table-light">
			      <th scope="col">Time</th>
			      <th scope="col">Title</th>
			      <th scope="col">Assignee</th>
			      <!-- <th scope="col">Assignees</th>
			      <th scope="col">Author</th> -->
			      <th scope="col">State</th>
			    </tr>
			  </thead>
			  <tbody>
			    <tr ng-repeat="issue in issues" ng-class="issue.eta == 0 ? 'table-danger' : 'table-secondary' ">
			      <th scope="row">{{issue.eta}}</th>
			      <th scope="row">
			      	<a ng-href="{{issue.web_url}}">{{issue.title}}</a>
			      </th>
			      <td>
			      	<img ng-src="{{issue.assignee.avatar_url}}" width="25px" height="25px">
			      	{{issue.assignee.name}}
			  	  </td>
			      <!-- <td>
			      	<img src="{{issue.assignees.avatar_url}}" width="25px" height="25px">
			      	{{issue.assignees.name}}
			      </td>
			      <td>
			      	<img src="{{issue.Author.avatar_url}}" width="25px" height="25px">
			      	{{issue.author.name}}
			      </td> -->
			      <td>{{issue.state}}</td>
			    </tr>
			  </tbody>
			</table> 
			</div>

			<div class="tab-pane fade" id="participants">
				
				<div class="card" ng-repeat="assignee in assignees">
				  <div class="card-body">
				    <div class="row">
				    	<div class="col-1">
				    		<img ng-src="{{assignee.avatar_url}}" width="50px" height="50px">
 				    	</div>
				    	<div class="col-11">
				    		<h5>{{assignee.name}} | {{assignee.percentage}}%</h5>
				    		<div class="progress">
				    		  <div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" aria-valuenow="{{assignee.percentage}}" aria-valuemin="0" aria-valuemax="100" style="width: {{assignee.percentage}}%"></div>
				    		</div>
				    		<hr/>
				    		<ul>
				    			<li ng-repeat="aissue in assignee.issues">
				    				<span ng-class="aissue.eta == 0 ? 'badge badge-danger badge-pill' : 'badge badge-primary badge-pill'">{{aissue.eta}}</span>
				    				<a href="{{aissue.web_url}}">{{aissue.title}}</a>
				    			</li>
				    		</ul>
				    	</div>
				    </div>
				  </div>
				</div>

			</div>
		</div>
	</div>

	<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
	<script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.3/js/bootstrap.min.js" integrity="sha384-ChfqqxuZUCnJSK3+MXmPNIyE6ZbWh2IMqE241rYiqJxyMiZ6OW/JmZQ5stwEULTy" crossorigin="anonymous"></script>

	<script type="text/javascript">
		var private_token = 'zwU6ZuYrAs52ZF729Scs';
		var milestonesApp = angular.module("milestonesList", []); 
		milestonesApp.controller("milestonesCtrl", function($scope, HttpService) {
		    HttpService.getMilestones()
			.then(function(response) {
				var response_data = [];
				angular.forEach(response, function(value, key) {
				  	response_data[key] = {
				  		'id' : value.id,
				  		'title' : value.title,
				  		'state' : value.state,
				  	};
				});
				$scope.milestones = response_data;
			});
			$scope.loadIssues = function (id) {
			    HttpService.getIssues(id)
				.then(function(response) {
					var issues = [];
					var assignee = [];
					var totalETA = 0;
					angular.forEach(response, function(value, key) {
					  	issues[key] = {
					  		'id' : value.id,
					  		'title' : value.title,
					  		'state' : value.state,
					  		'assignee' : value.assignee,
					  		'assignees' : value.assignees,
					  		'author' : value.author,
					  		'web_url' : value.web_url,
					  		'labels' : value.labels,
					  		'eta' : calManPower(value.title),
					  	};
					  	assignee[value.assignee.id] = value.assignee;
					  	totalETA += issues[key]['eta'];
					});
					$scope.issues = issues;
					$scope.totalETA = totalETA;
					var assignees = [];
					var count = 0;
					angular.forEach(assignee, function(value, key) {
						var tempIssues = [];
						var totalETA = 0;
						var issue_count = 0;
						angular.forEach(response, function(v, k) {
							if (value.id == v.assignee.id) {
								tempIssues.push({
									'id' : v.id,
									'title' : v.title,
									'state' : v.state,
									'assignee' : v.assignee,
									'assignees' : v.assignees,
									'author' : v.author,
									'web_url' : v.web_url,
									'labels' : v.labels,
									'eta' : calManPower(v.title),
								});
								totalETA += calManPower(v.title);
							}
						});
						var percentage = ((totalETA/85)*100).toFixed(2);
						assignees[count++] = {
							'name' : value.name,
							'username' : value.username,
							'avatar_url' : value.avatar_url,
							'issues' : tempIssues,
							'totalETA' : totalETA,
							'percentage' : percentage,
						};
					});
					$scope.assignees = assignees;
					$scope.nOfParticipant = count;
					$scope.totalTime = $scope.nOfParticipant * 8.5 * 10;
					$scope.percentage = (($scope.totalETA/$scope.totalTime)*100).toFixed(2);
					console.log(assignees);
				});
				HttpService.getMilestoneDetails(id)
				.then(function(response) {
					$scope.details = response;
				});

			};
			calManPower = function (title) {
				var count = 0;
				if(title.match(/[^[\]]+(?=])/g)) {
					str = title.match(/[^[\]]+(?=])/g)[0];
					strDays = 0;
					if (!isNaN(str)) {
						strDays = parseFloat(str);
						count +=  parseFloat(strDays * 8.5);
					} else if (/h/.test(str) && /[0-9]/.test(str)) {
						count += parseFloat(str);
					} else if (/d/.test(str) && /[0-9]/.test(str)) {
						strDays = parseFloat(str);
						count +=  parseFloat(strDays * 8.5);
					} else {
						$scope.errorSub = "Some issue has not calculated to total time estimation";
					}
				} else {
					$scope.errorMain = "Some issue has not time estimation";
				}
				return count;
			}
		});
		milestonesApp.service('HttpService', function($http) {
		  return {
		    getMilestones: function() {
		    return $http.get('https://code.thinkcube.net/api/v4/projects/ezbiz%2Fcore/milestones?private_token=' + private_token)
		       .then(function (response) { return response.data; });
		    },
		    getIssues: function(id) {
		    return $http.get('https://code.thinkcube.net/api/v4/projects/ezbiz%2Fcore/milestones/'+id+'/issues?page=1&per_page=100&private_token=' + private_token)
		       .then(function (response) { return response.data; });
		    },
		    getMilestoneDetails: function(id) {
		    return $http.get('https://code.thinkcube.net/api/v4/projects/ezbiz%2Fcore/milestones/'+id+'?page=1&per_page=100&private_token=' + private_token)
		       .then(function (response) { return response.data; });
		    }
		  };
		});

	</script>

</body>
</html>